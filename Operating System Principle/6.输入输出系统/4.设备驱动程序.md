[输入输出系统](../操作系统原理.md)
# 设备驱动程序
<!-- TOC -->

- [设备驱动程序](#设备驱动程序)
  - [概述](#概述)
    - [功能](#功能)
    - [特点](#特点)
  - [处理过程](#处理过程)
  - [控制方式](#控制方式)
    - [使用轮询的可编程IO方式](#使用轮询的可编程io方式)
    - [使用中断的可编程IO方式](#使用中断的可编程io方式)
    - [直接存储器访问（DMA）](#直接存储器访问dma)
    - [IO通道控制方式](#io通道控制方式)

<!-- /TOC -->
---
设备驱动程序是IO系统的高层与设备控制器之间的驱动程序。  
主要任务是接受上层软件发来的抽象IO要求，将其转换为具体要求后发给设备控制器去执行。  
也将设备控制器发来的信号传送给上层软件。

---
## 概述
### 功能
* 接受与设备无关的软件发来的命令和参数
* 检查用户IO请求的合法性
* 发出IO指令
* 及时响应由设备控制器发来的中断请求

### 特点
* 驱动程序是实现在与设备无关的软件与设备控制器之间通信和转换的程序
* 驱动程序与设备控制器以及IO设备的硬件特性紧密相关
* 驱动程序与IO设备所采用的IO控制方式紧密相关
* 由于驱动程序与硬件紧密相关，其中一部分用汇编语言书写，且基本部分固化在ROM中
* 驱动程序允许可重入

---
## 处理过程
* 将抽象要求转化为具体要求
* 对服务进行校验
* 检查设备状态
* 传送必要参数
* 启动IO设备

状态寄存器格式：
|D7|D6|D5|D4|D3|D2|D1|D0|
|----|----|----|----|----|----|----|----|
|DSR|SYN DET|FE|OE|PE|Tx EMP|Rx RDY|Tx RDY|
|DSR针脚状态|检出SYNC特征|组帧错误|溢出错误|奇偶校验错误|发送器空|接受就绪|发送就绪|

---
## 控制方式
### 使用轮询的可编程IO方式
在处理机向控制器发出IO指令，启动输入设备输入数据时，同时把状态寄存器中的**忙/闲标志busy**置1  
不断地循环判断busy（**轮询**）
* 当busy==1时输入机尚未输完一个字/字符，处理机继续判断
* 当busy==0时说明输入机已经将输入数据送入控制器的数据寄存器
    * 处理机将数据寄存器的数据取出，送入内存单元
    * 再次启动轮询去读入下一个数据

### 使用中断的可编程IO方式
当某个进程要启动某个IO设备时，由CPU向相应设备控制器发出IO指令，然后立即返回来执行原来的任务  
此时设备控制器按照指令去控制相应设备，CPU与IO设备并行操作。

### 直接存储器访问（DMA）
虽然中断IO更加有效，但仍以字/字节为单位进行IO，每次完成一个字/字节的IO都要请求一次中断  
DMA进一步提高了CPU与IO设备的并行操作程度
* 特点
    * 数据传输的基本单位是**数据块**
    * 数据从设备直接送入内存
    * 仅在传送数据块的开始和结束时由CPU干预
* 组成
    * 主机与DMA控制器的接口
    * DMA控制器与块设备的接口
    * IO控制逻辑
* 工作流程
    * 当CPU要从磁盘读入数据块时，向磁盘控制器发出读命令
    * 命令被送入命令寄存器CR中
    * 同时，将要读入的数据的始址送入内存地址寄存器MAR中

### IO通道控制方式
虽然DMA已经显著减少了CPU的干预，但CPU每次发出IO指令也只能去IO一个数据块  
要IO多个数据块并将其放入不同内存区时，仍然需要发出多次IO指令并请求多次中断  
* 特点
    * 以**数据块组**为单位，进一步减少CPU的干预
* 通道程序
    * 通道通过执行通道程序，与设备控制器共同实现对IO设备的控制
    * 通道程序是一组通道指令